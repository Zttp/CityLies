import { DisplayValueHeader, Color, Vector3 } from 'pixel_combats/basic';
import { Game, Map, MapEditor, Players, Inventory, LeaderBoard, BuildBlocksSet, Teams, Damage, BreackGraph, Ui, Properties, GameMode, Spawns, Timers, TeamsBalancer, Build, AreaService, AreaPlayerTriggerService, AreaViewService, Chat } from 'pixel_combats/room';

// –û—Ç–∫–ª—é—á–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∏ —É—Ä–æ–Ω
Teams.Add('Builders', '–°—Ç—Ä–æ–∏—Ç–µ–ª–∏', new Color(0.2, 0.8, 0.2, 0.5));
const BuildersTeam = Teams.Get('Builders');
Damage.Enable.Value = false;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
BuildersTeam.Build.BlocksSet.Value = BuildBlocksSet.White;
Build.Enable.Value = true;
Build.Infinity.Value = true;

// –û—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É
Map.Clear();

// –°–æ–∑–¥–∞–µ–º —É—á–µ–±–Ω—ã–µ –∑–æ–Ω—ã
const tutorialZones = [
    { 
        name: "–û—Å–Ω–æ–≤—ã", 
        position: new Vector3(-20, 5, 0),
        size: new Vector3(10, 10, 10),
        color: new Color(1, 1, 1, 0.3)
    },
    { 
        name: "–§—É–Ω–¥–∞–º–µ–Ω—Ç", 
        position: new Vector3(0, 5, 0),
        size: new Vector3(10, 10, 10),
        color: new Color(0.8, 0.5, 0.2, 0.3)
    },
    { 
        name: "–°–∏–º–º–µ—Ç—Ä–∏—è", 
        position: new Vector3(20, 5, 0),
        size: new Vector3(10, 10, 10),
        color: new Color(0.2, 0.5, 0.8, 0.3)
    },
    { 
        name: "–û–∫–Ω–∞ –∏ –¥–≤–µ—Ä–∏", 
        position: new Vector3(40, 5, 0),
        size: new Vector3(10, 10, 10),
        color: new Color(0.8, 0.2, 0.8, 0.3)
    },
    { 
        name: "–ö—Ä—ã—à–∏", 
        position: new Vector3(60, 5, 0),
        size: new Vector3(10, 10, 10),
        color: new Color(0.5, 0.8, 0.5, 0.3)
    }
];

// –°–æ–∑–¥–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ –∑–æ–Ω—ã
tutorialZones.forEach(zone => {
    const area = AreaService.CreateBox(zone.position, zone.size);
    AreaViewService.Create(area, zone.color, zone.name);
    
    AreaPlayerTriggerService.Create(area).OnEnter.Add((player) => {
        showTutorialStep(player, zone.name);
    });
});

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É—á–µ–±–Ω–æ–≥–æ —à–∞–≥–∞
function showTutorialStep(player, stepName) {
    switch(stepName) {
        case "–û—Å–Ω–æ–≤—ã":
            player.Ui.Hint.Value = `
<b>üéØ –û—Å–Ω–æ–≤—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞:</b>
1. –ù–∞–∂–º–∏—Ç–µ [B] —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
2. –í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ –∏–∑ –ø–∞–Ω–µ–ª–∏
3. –õ–ö–ú - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–ª–æ–∫
4. –ü–ö–ú - —É–¥–∞–ª–∏—Ç—å –±–ª–æ–∫
5. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–ª–µ—Å–æ –º—ã—à–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∫–∏—Å—Ç–∏

<b>–ü—Ä–∞–∫—Ç–∏–∫–∞:</b>
–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Å—Ç—É—é —Å—Ç–µ–Ω—É 3x3 –±–ª–æ–∫–∞`;
            break;
            
        case "–§—É–Ω–¥–∞–º–µ–Ω—Ç":
            player.Ui.Hint.Value = `
<b>üèó –§—É–Ω–¥–∞–º–µ–Ω—Ç - –æ—Å–Ω–æ–≤–∞ –∑–¥–∞–Ω–∏—è:</b>
1. –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π—Ç–µ —Å –ø—Ä–æ—á–Ω–æ–≥–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—è
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ —Ç–æ–ª—Å—Ç—ã–µ –±–ª–æ–∫–∏ –¥–ª—è —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞
3. –£–≥–ª—É–±–ª—è–π—Ç–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –≤ –∑–µ–º–ª—é –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
4. –ß–µ–º –≤—ã—à–µ –∑–¥–∞–Ω–∏–µ - —Ç–µ–º –ø—Ä–æ—á–Ω–µ–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç

<b>–ü—Ä–∞–∫—Ç–∏–∫–∞:</b>
–ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç 5x5 –±–ª–æ–∫–æ–≤, —É–≥–ª—É–±–ª–µ–Ω–Ω—ã–π –Ω–∞ 2 –±–ª–æ–∫–∞ –≤–Ω–∏–∑`;
            break;
            
        case "–°–∏–º–º–µ—Ç—Ä–∏—è":
            player.Ui.Hint.Value = `
<b>‚öñÔ∏è –°–∏–º–º–µ—Ç—Ä–∏—è –≤ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ:</b>
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Ç–∫—É (–Ω–∞–∂–º–∏—Ç–µ [G] –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è)
2. –°—Ç—Ä–æ–π—Ç–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –∫ –∫—Ä–∞—è–º
3. –î–ª—è —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã—Ö –∑–¥–∞–Ω–∏–π —Å–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –æ—Å—å —Å–∏–º–º–µ—Ç—Ä–∏–∏
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–µ—á–µ—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —á–µ—Ç–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞

<b>–ü—Ä–∞–∫—Ç–∏–∫–∞:</b>
–ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—É—é –±–∞—à–Ω—é —Å —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –æ—Å—å—é`;
            break;
            
        case "–û–∫–Ω–∞ –∏ –¥–≤–µ—Ä–∏":
            player.Ui.Hint.Value = `
<b>ü™ü –û–∫–Ω–∞ –∏ –¥–≤–µ—Ä–∏:</b>
1. –û—Å—Ç–∞–≤–ª—è–π—Ç–µ –ø—É—Å—Ç—ã–µ –±–ª–æ–∫–∏ –¥–ª—è –æ–∫–æ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–º–æ–≤
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –¥–ª—è –æ–∫–æ–Ω
3. –î–µ–ª–∞–π—Ç–µ –¥–≤–µ—Ä–Ω—ã–µ –ø—Ä–æ–µ–º—ã –º–∏–Ω–∏–º—É–º 2 –±–ª–æ–∫–∞ –≤ –≤—ã—Å–æ—Ç—É
4. –ß–µ—Ä–µ–¥—É–π—Ç–µ –æ–∫–Ω–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —Ñ–∞—Å–∞–¥–∞
5. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª—É–±–ª–æ–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–≤–µ—Ä–Ω—ã—Ö –∫–æ—Å—è–∫–æ–≤

<b>–ü—Ä–∞–∫—Ç–∏–∫–∞:</b>
–ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Å—Ç–µ–Ω—É —Å 2 –æ–∫–Ω–∞–º–∏ –∏ 1 –¥–≤–µ—Ä–Ω—ã–º –ø—Ä–æ–µ–º–æ–º`;
            break;
            
        case "–ö—Ä—ã—à–∏":
            player.Ui.Hint.Value = `
<b>üè† –í–∏–¥—ã –∫—Ä—ã—à:</b>
1. –ü–ª–æ—Å–∫–∞—è - –ø—Ä–æ—Å—Ç–µ–π—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
2. –°–∫–∞—Ç–Ω–∞—è - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—É–ø–µ–Ω—á–∞—Ç—ã–µ –±–ª–æ–∫–∏
3. –ö—É–ø–æ–ª - —Å–ª–æ–∂–Ω–∞—è, –Ω–æ –∫—Ä–∞—Å–∏–≤–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
4. –®–∞—Ç—Ä–æ–≤–∞—è - —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è —Å–æ –≤—Å–µ—Ö —Å—Ç–æ—Ä–æ–Ω

<b>–°–æ–≤–µ—Ç—ã:</b>
- –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å —É–≥–ª–æ–≤ –∏ –¥–≤–∏–≥–∞–π—Ç–µ—Å—å –∫ —Ü–µ–Ω—Ç—Ä—É
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª—É–±–ª–æ–∫–∏ –¥–ª—è –ø–ª–∞–≤–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- –î–µ–ª–∞–π—Ç–µ —Å–≤–µ—Å—ã –∫—Ä—ã—à–∏ –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç–∏

<b>–ü—Ä–∞–∫—Ç–∏–∫–∞:</b>
–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å —Å–∫–∞—Ç–Ω—É—é –∫—Ä—ã—à—É –Ω–∞ —Å–≤–æ–µ–º –∑–¥–∞–Ω–∏–∏`;
            break;
    }
}

// –ü—Ä–∏ –≤—Ö–æ–¥–µ –∏–≥—Ä–æ–∫–∞
Players.OnPlayerConnected.Add(function(player) {
    BuildersTeam.Add(player);
    player.Properties.Add('TutorialStep', 0);
    
    // –î–∞–µ–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    player.inventory.Main.Value = false;
    player.inventory.Secondary.Value = false;
    player.inventory.Melee.Value = true;
    player.spawns.spawn();
    
    // –ü–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    player.Ui.Hint.Value = `
<b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ç—É—Ç–æ—Ä–∏–∞–ª –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É!</b>
–ü–µ—Ä–µ–º–µ—â–∞–π—Ç–µ—Å—å –º–µ–∂–¥—É —Ü–≤–µ—Ç–Ω—ã–º–∏ –∑–æ–Ω–∞–º–∏, —á—Ç–æ–±—ã –∏–∑—É—á–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞.

<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏:</b>
[B] - –º–µ–Ω—é —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
[G] - –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å–µ—Ç–∫—É
[F] - –∏–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
[–ü—Ä–æ–±–µ–ª] + [–õ–ö–ú] - –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫
[–ü—Ä–æ–±–µ–ª] + [–ü–ö–ú] - –≤—Å—Ç–∞–≤–∏—Ç—å –±–ª–æ–∫

–ù–∞—á–Ω–∏—Ç–µ —Å –±–µ–ª–æ–π –∑–æ–Ω—ã "–û—Å–Ω–æ–≤—ã" —Å–ª–µ–≤–∞.`;
    
    // –¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫ –Ω–∞—á–∞–ª—É
    player.Spawns.Spawn(new Vector3(-20, 10, 0));
});

// –ß–∞—Ç-–∫–æ–º–∞–Ω–¥—ã
Chat.OnMessage.Add(function(m) {
    const msg = m.Text.toLowerCase().trim();
    const player = Players.GetByRoomId(m.Sender);
    
    if (msg === '/help') {
        player.Ui.Hint.Value = `
<b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
/tools - —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
/tips - —Å–ª—É—á–∞–π–Ω—ã–π —Å–æ–≤–µ—Ç –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤—É
/reset - —Å–±—Ä–æ—Å–∏—Ç—å —Å–≤–æ—é –ø–æ—Å—Ç—Ä–æ–π–∫—É
/grid - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–µ—Ç–∫—É`;
    }
    else if (msg === '/tools') {
        player.Ui.Hint.Value = `
<b>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞:</b>
1. –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ - –±–∞–∑–æ–≤—ã–π —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
2. –ü–æ–ª—É–±–ª–æ–∫ - –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –ø–ª–∞–≤–Ω—ã—Ö —Ñ–æ—Ä–º
3. –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –±–ª–æ–∫ - –¥–ª—è –æ–∫–æ–Ω –∏ –¥–µ–∫–æ—Ä–∞
4. –õ–µ—Å—Ç–Ω–∏—Ü–∞ - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
5. –î–≤–µ—Ä—å - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥—Ö–æ–¥–µ`;
    }
    else if (msg === '/tips') {
        const tips = [
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ç–µ–∫—Å—Ç—É—Ä—ã –±–ª–æ–∫–æ–≤ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è",
            "–î–æ–±–∞–≤—å—Ç–µ –∫–æ–ª–æ–Ω–Ω—ã –ø–æ —É–≥–ª–∞–º –∑–¥–∞–Ω–∏—è –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏",
            "–°–æ–∑–¥–∞–π—Ç–µ –±–∞–ª–∫–æ–Ω —Å –ø–æ–º–æ—â—å—é –ø–æ–ª—É–±–ª–æ–∫–æ–≤",
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–µ—Å—Ç–Ω–∏—Ü—ã –∫–∞–∫ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã",
            "–ü–æ—Å—Ç—Ä–æ–π—Ç–µ —Ñ–æ–Ω—Ç–∞–Ω –≤ —Ü–µ–Ω—Ç—Ä–µ –¥–≤–æ—Ä–∞",
            "–î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–∫–µ–ª—ã –¥–ª—è –æ—Å–≤–µ—â–µ–Ω–∏—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏"
        ];
        player.Ui.Hint.Value = `<b>–°–æ–≤–µ—Ç:</b> ${tips[Math.floor(Math.random() * tips.length)]}`;
    }
    else if (msg === '/reset') {
        Map.Clear();
        player.Ui.Hint.Value = "–í–∞—à–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∞ –±—ã–ª–∞ —Å–±—Ä–æ—à–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ!";
    }
    else if (msg === '/grid') {
        Build.ShowGrid.Value = !Build.ShowGrid.Value;
        player.Ui.Hint.Value = `–°–µ—Ç–∫–∞ ${Build.ShowGrid.Value ? "–≤–∫–ª—é—á–µ–Ω–∞" : "–≤—ã–∫–ª—é—á–µ–Ω–∞"}`;
    }
});

// –¢–∞–π–º–µ—Ä —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
const TipsTimer = Timers.GetContext().Get('TipsTimer');
TipsTimer.OnTimer.Add(function(t) {
    Players.ForEach(function(player) {
        if (Math.random() > 0.7) {
            player.Ui.Hint.Value = "<b>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</b> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –±–ª–æ–∫–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö —Ç–µ–∫—Å—Ç—É—Ä –≤ –≤–∞—à–∏—Ö –ø–æ—Å—Ç—Ä–æ–π–∫–∞—Ö!";
        }
    });
    TipsTimer.RestartLoop(60);
});
